<div class="base">
    <div class="char-header-main">
        <div class="char-header-4col">
            <span>Character Name</span>
            <input type="text" class="basics" name="attr_characterName" value="" placeholder="Enter Name">
            <span>Class</span>
            <input type="text" class="basics" name="attr_characterClass" value="" placeholder="Enter Class">
            <span>Renoun</span>
            <input type="number" name="attr_renoun" value="0">
            <span>Level</span>
            <input type="number" name="attr_level" value="0">
            <span>Ancestry</span>
            <input type="text" name="attr_ancestry" value="0">
        </div>
        <div class="char-header-2col">
            <span>Career</span>
            <input type="text" name="attr_career" value="" placeholder="Enter Career">
            <span>Complications</span>
            <input type="text" name="attr_complication" value="" placeholder="Enter Complication">
            <span>Languages</span>
            <input type="text" name="attr_languages" value="" placeholder="Enter Languages">
        </div>
    </div>
    <div class="char-top-layout-2col">
        <div>
            Attributes and Skills
            <div class="char-stats-5col">
                <span><button type="action" name="act_test" value="&{template:drawsteelbasic}{{char-name=@{characterName}}}{{roll-type=Might}}{{roll=[[2d10+@{mgt}]]}}{{critical=[[0]]}}">MGT</button></span>
                <span><button type="action" name="act_test" value="&{template:drawsteelbasic}{{char-name=@{characterName}}}{{roll-type=Agility}}{{roll=[[2d10+@{agl}]]}}{{critical=[[0]]}}">AGL</button></span>
                <span><button type="action" name="act_test" value="&{template:drawsteelbasic}{{char-name=@{characterName}}}{{roll-type=Reason}}{{roll=[[2d10+@{rea}]]}}{{critical=[[0]]}}">REA</button></span>
                <span><button type="action" name="act_test" value="&{template:drawsteelbasic}{{char-name=@{characterName}}}{{roll-type=Intuition}}{{roll=[[2d10+@{inu}]]}}{{critical=[[0]]}}">INU</button></span>
                <span><button type="action" name="act_test" value="&{template:drawsteelbasic}{{char-name=@{characterName}}}{{roll-type=Presence}}{{roll=[[2d10+@{prs}]]}}{{critical=[[0]]}}">PRS</button></span>

                <input type="number" name="attr_mgt" value="0">
                <input type="number" name="attr_agl" value="0">
                <input type="number" name="attr_rea" value="0">
                <input type="number" name="attr_inu" value="0">
                <input type="number" name="attr_prs" value="0">
            </div>  
        </div>
        <div>
            Repeating Stuff
            <div>
                Attacks?
                 <fieldset class="repeating_attacks">
                    <div>
                        <div>
                            <input type="text" name="attr_atknamedisp" value="@{atkname}" width="100%" disabled="true">
                            <button type="action" name="act_attackroll">X</button>
                        </div>
                        <input type="checkbox" class="sheet-foo">
                        <div class="sheet-bar">
                            <div>
                                <input type="text" name="attr_atkname" value="Attack" width="100%" placeholder="Attack Name">
                            </div>
                            <div class="rpt_2col">
                                <span>Distance:</span><input type="text" name="attr_atkdistance" placeholder="Distance">
                            </div>
                            <div class="rpt_2col">
                                <span>Target:</span><input type="text" name="attr_atktarget" placeholder="One Target">
                            </div>
                            <div class="rpt_3col"> 
                                <span>XXX</span><span>Damage</span><span>Special</span>
                                <span>Tier 1</span><span><input type="text" name="attr_atktier1dmg" class="small-val-input" value="" placeholder="2"></span ><input type="text" name="attr_atktier1desc" value="" placeholder="Special Effect">
                                <span>Tier 2</span><span><input type="text" name="attr_atktier2dmg" class="small-val-input" value="" placeholder="2"></span><span><input type="text" name="attr_atktier2desc" value="" placeholder="Special Effect"></span>
                                <span>Tier 3</span><span><input type="text" name="attr_atktier3dmg" class="small-val-input" value="" placeholder="2"></span><span><input type="text" name="attr_atktier3desc" value="" placeholder="Special Effect"></span>
                            </div>
                        </div>

                    </div>
                 </fieldset>
            </div>
        </div>
    </div>
    <div>
        <button type="action" name="act_test" value="&{template:drawsteelbasic}{{char-name=@{characterName}}}{{roll-type=testing}}{{roll=[[2d10]]}}{{modifier=@{mgt}}}{{critical=[[0]]}}">Click me</button>
        
    </div>
</div>

</div>


<!-- {{roll=[[2d10+@{mgt}]]}}{{critical=[[0]]}}{{rollresult=None}}{{damagenum=[[0]]}}{{specialnote=None}}{{t1d=@{atktier1dmg}}}{{t1sp=@{atktier1desc}}}{{t2d=@{atktier2dmg}}}{{t2sp=@{atktier2desc}}}{{t3d=@{atktier3dmg}}}{{t3sp=@{atktier3desc}}} -->
<!-- TEMPLATES TEMPLATES TEMPLATES TEMPLATES TEMPLATES TEMPLATES TEMPLATES TEMPLATES TEMPLATES TEMPLATES TEMPLATES TEMPLATES -->

<rolltemplate class="sheet-rolltemplate-drawsteelbasic">
    <div class="sheet-template-title">
        {{#char-name}}
        <span>{{char-name}}: </span>
        {{/char-name}}
        <span> {{roll-type}}</span>
        <span>{{roll}}</span>
    </div>
    <div class="sheet-template-body">
        {{#rollGreater() computed::critical 0}}<div class="sheet-template-crit">Critical</div>{{/rollGreater() computed::critical 0}}
        {{#rollLess() roll 12}}<div class="sheet-template-result">Tier 1 Result</div>{{/rollLess() roll 12}}
        {{#rollBetween() roll 12 16}}<div class="sheet-template-result">Tier 2 Result</div>{{/rollBetween() roll 12 16}}
        {{#rollGreater() roll 16}}<div class="sheet-template-result">Tier 3 Result</div>{{/rollGreater() roll 16}}
    </div>
</rolltemplate>

<rolltemplate class="sheet-rolltemplate-drawsteelattack">
    <div class="sheet-template-title">
        {{#char-name}}
        <span>{{char-name}}: </span>
        {{/char-name}}
        <span> {{roll-type}}</span>
        <span>{{roll}}</span>
    </div>
    <div class="sheet-template-body">
        {{#rollGreater() computed::critical 0}}<div class="sheet-template-crit">Critical</div>{{/rollGreater() computed::critical 0}}
        {{#rollLess() roll 12}}
            <div class="sheet-template-result">
                <span>Tier 1 Result</span>
                <span>{{t1dmg}}</span>
                <span>{{t1desc}}</span>
            </div>
        {{/rollLess() roll 12}}
        {{#rollBetween() roll 12 16}}
            <div class="sheet-template-result"></div>
                <span>Tier 2 Result</span>
                <span>{{t2dmg}}</span>
                <span>{{t2desc}}</span>
            </div>
        {{/rollBetween() roll 12 16}}
        {{#rollGreater() roll 16}}
            <div class="sheet-template-result">
                <span>Tier 3 Result</span>
                <span>{{t3dmg}}</span>
                <span>{{t3desc}}</span>
            </div>
        {{/rollGreater() roll 16}}
    </div>
</rolltemplate>

<rolltemplate class="sheet-rolltemplate-test">
    Full Roll = {{roll1}} <br />
    Critical? = {{computed::critical}}<br />
</rolltemplate>

<!-- SCRIPTS SCRIPTS SCRIPTS SCRIPTS SCRIPTS SCRIPTS SCRIPTS SCRIPTS SCRIPTS SCRIPTS SCRIPTS SCRIPTS SCRIPTS SCRIPTS SCRIPTS-->
<script type="text/worker">

    on ('clicked:test', (event) => {
        testRoll(event.htmlAttributes.value);
    });
    
    
    const testRoll = (rollExp) => {

        console.log(rollExp);

        startRoll(rollExp, (results) => {
            console.log("In Generic startRoll");
            rolldata = {};
            rolldata.critical = isCrit(results.results.roll.dice[0], results.results.roll.dice[1]);
            finishRoll(results.rollId, rolldata);
        });
    } 

    on ('clicked:repeating_attacks', (event) => {
        console.log("Starting event in repeating_attacks");
        // Get the rowId
        const trigger = event.sourceAttribute.split('_');
        const rowid = trigger[2];
        console.log("Row ID: " + rowid);
        // Get the fields
        attackFields = {};
        getAttrs([
            "repeating_attacks_"+rowid+"_atkname",
            "repeating_attacks_"+rowid+"_atktier1dmg",
            "repeating_attacks_"+rowid+"_atktier1desc",
            "repeating_attacks_"+rowid+"_atktier2dmg",
            "repeating_attacks_"+rowid+"_atktier2desc",
            "repeating_attacks_"+rowid+"_atktier3dmg", 
            "repeating_attacks_"+rowid+"_atktier3desc"
        ], function(values) {
            attackFields.name = values["repeating_attacks_"+rowid+"_atkname"];
            attackFields.t1dmg = values["repeating_attacks_"+rowid+"_atktier1dmg"];
            attackFields.t2dmg = values["repeating_attacks_"+rowid+"_atktier2dmg"];
            attackFields.t3dmg = values["repeating_attacks_"+rowid+"_atktier3dmg"];
            attackFields.t1desc = values["repeating_attacks_"+rowid+"_atktier1desc"];
            attackFields.t2desc = values["repeating_attacks_"+rowid+"_atktier2desc"];
            attackFields.t2desc = values["repeating_attacks_"+rowid+"_atktier3desc"];
         });

         rollText="&{template:drawsteelattack}{{roll=[[2d10]]}}{{char-name=@{characterName}}}{{roll-type=@{repeating_attacks_"+rowid+"_atkname}}}{{critical=[[0]]}}{{t1dmg=@{repeating_attacks_"+rowid+"_atktier1dmg}}}{{t2dmg=@{repeating_attacks_"+rowid+"_atktier2dmg}}}{{t2dmg=@{repeating_attacks_"+rowid+"_atktier2dmg}}}{{t1desc=@{repeating_attacks_"+rowid+"_atktier1desc}}}{{t2desc=@{repeating_attacks_"+rowid+"_atktier2desc}}}{{t3desc=@{repeating_attacks_"+rowid+"_atktier3desc}}}";


         attackRoll(rollText);
    });

    const attackRoll = (rollText) => {
        console.log("Attack Roll Start");

        startRoll(rollText, (results) => {
            console.log("In Attack startRoll");
            rolldata = {};
            rolldata.critical = isCrit(results.results.roll.dice[0], results.results.roll.dice[1]);
            console.log(results);
            finishRoll(results.rollId, rolldata);
        });
    }

    function isCrit(num1, num2){
        if((num1+num2)>18){
            console.log("Crit!")
            return 1;
        }else{
            return 0;
        }
    }

</script>